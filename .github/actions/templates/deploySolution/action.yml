name: 'Deploy Solution'
description: 'Validate and Deploy CARML Bicep solution'

inputs:
  subscriptionId:
    description: 'The subscriptionId to deploy to'
    required: true
  location:
    description: 'The location to use for deployment'
    required: false
  templateFilePath:
    description: 'The path to the template file to use for deployment'
    required: true
  parameterFilePath:
    description: 'The path to the parameter file to use for deployment'
    required: true


runs:
  using: 'composite'
  steps:

    # --------------- #
    #  Login to Azure #
    # --------------- #
    - name: Azure Login
      uses: Azure/login@v1
      with:
        creds: ${{ env.AZURE_CREDENTIALS }}
        enable-AzPSSession: true

    # ------------------------------------- #
    #  Validate the Subscription Deployment #
    # ------------------------------------- #
    - name: 'Validate [${{ inputs.subscriptionId }}] Azure subscription deployment'
      shell: pwsh
      run: |
        Install-module Az -AllowClobber -Force
        Import-module Az

        Select-AzSubscription ${{ inputs.subscriptionId }}

        Test-AzDeployment `
          -Location ${{ inputs.location }} `
          -TemplateFile ${{ inputs.templateFilePath }} `
          -TemplateParameterFile ${{ inputs.parameterFilePath }} `
          -Verbose

    # ------------------------ #
    #  Subscription Deployment #
    # ------------------------ #
    - name: 'Validate [${{ inputs.subscriptionId }}] Azure subscription deployment'
      shell: pwsh
      run: |
        Install-module Az -AllowClobber -Force
        Import-module Az

        Select-AzSubscription ${{ inputs.subscriptionId }}

        New-AzSubscriptionDeployment `
          -Location ${{ inputs.location }} `
          -TemplateFile ${{ inputs.templateFilePath }} `
          -TemplateParameterFile ${{ inputs.parameterFilePath }} `
          -Verbose
